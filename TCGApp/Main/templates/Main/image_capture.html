<!--Image Capture template created by Jared McCain-->
<!--OCR detection and parsing created by Marlon Chavez-->
<!--Early implementation of image capturing created by Jose Bernal-->
{% extends 'Main/base.html' %}

{% block title %}Image Capture{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">Capture Your Card</h1>
  <p class="text-center mb-4">Use your webcam to snap a picture of your card, then select the exact variant you own.</p>

  <!-- 1) Camera Feed -->
  <div class="d-flex justify-content-center mb-3">
    <video id="video" width="640" height="480" autoplay class="border"></video>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- 2) Capture Button -->
  <div class="d-flex justify-content-center mb-4">
    <button id="capture" type="button" class="btn btn-success">Capture</button>
  </div>

  <!-- 3) Preview + Retry/Upload -->
  <div id="preview-section" class="text-center" style="display:none;">
    <img id="capturedImage" class="img-fluid border mb-3" style="max-width:640px; height:auto;" />
    <div>
      <button id="retry"    type="button" class="btn btn-warning me-2">Retry</button>
      <button id="upload"   type="button" class="btn btn-primary">Upload</button>
    </div>
  </div>

  <!-- 4) OCR Results & Choice List -->
  <div id="results" class="mt-5" style="display:none;">
    <h4>Detected Text:</h4>
    <p id="text_result" class="fst-italic"></p>

    <form id="choice-form" class="mt-3">
      <!-- JS will inject a list of radio buttons here -->
    </form>
  </div>

  <!-- Hidden form field for image data + CSRF -->
  <form id="hidden-form" style="display:none;">
    {% csrf_token %}
    <input type="hidden" id="image_data" name="image_data" />
  </form>
</div>

<script>
  const video         = document.getElementById("video");
  const canvas        = document.getElementById("canvas");
  const ctx           = canvas.getContext("2d");
  const captureBtn    = document.getElementById("capture");
  const retryBtn      = document.getElementById("retry");
  const uploadBtn     = document.getElementById("upload");
  const previewImg    = document.getElementById("capturedImage");
  const previewSec    = document.getElementById("preview-section");
  const textResult    = document.getElementById("text_result");
  const resultsDiv    = document.getElementById("results");
  const choiceForm    = document.getElementById("choice-form");
  const hiddenForm    = document.getElementById("hidden-form");
  const imageDataInpt = document.getElementById("image_data");

  // 1) start webcam
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => console.error("Camera error:", err));

  // 2) capture frame
  captureBtn.addEventListener("click", () => {
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const dataURL = canvas.toDataURL("image/png");
    previewImg.src = dataURL;
    imageDataInpt.value = dataURL;

    // show preview + controls
    previewSec.style.display = "block";
    video.style.display     = "none";
    captureBtn.style.display= "none";

    // call OCR (but do NOT save)
    runOCR(dataURL);
  });

  // 3) retry
  retryBtn.addEventListener("click", () => {
    previewSec.style.display = "none";
    resultsDiv.style.display = "none";
    choiceForm.innerHTML     = "";
    video.style.display      = "block";
    captureBtn.style.display = "inline-block";
  });

  // 4) OCR & build choice list
  function runOCR(dataURL) {
    fetch("{% url 'webcam_capture' %}", {
      method: "POST",
      body: new FormData(hiddenForm), // includes CSRF + image_data
    })
    .then(res => res.json())
    .then(json => {
      // show detected text
      textResult.textContent = json.text_result || "No text detected.";
      resultsDiv.style.display = "block";

      // build radio choices
      if (json.matching_cards?.length) {
        choiceForm.innerHTML = json.matching_cards.map((c, i) => `
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio"
                   name="selected_card" id="card${i}"
                   value="${c.id}" ${i===0?'checked':''}>
            <label class="form-check-label d-flex align-items-center" for="card${i}">
              <img src="${c.imageUrl}" width="50" class="me-2 rounded"/> 
              <div>
                <strong>${c.cleanName}</strong><br>
                <small>${c.subTypeName} — $${c.marketPrice}</small>
              </div>
            </label>
          </div>`).join("");
      } else {
        choiceForm.innerHTML = `<p class="text-muted">No matching cards found.</p>`;
      }
    })
    .catch(err => {
      console.error("OCR failed:", err);
      textResult.textContent = "Error during OCR.";
      resultsDiv.style.display = "block";
    });
  }

  // 5) upload only when they click “Upload”
  uploadBtn.addEventListener("click", () => {
    const selected = choiceForm.querySelector('input[name="selected_card"]:checked');
    if (!selected) {
      return alert("Please select which variant you own.");
    }
    const form = new FormData(hiddenForm);
    form.append("save", "true");
    form.append("card_id", selected.value);

    fetch("{% url 'webcam_capture' %}", {
      method: "POST",
      body: form,
    })
    .then(res => res.json())
    .then(json => {
      if (json.success) {
        alert("Card saved!");
        window.location.href = "{% url 'scanned_cards' %}";
      } else {
        alert("Save failed: " + (json.error||"unknown"));
      }
    })
    .catch(err => {
      console.error("Upload error:", err);
      alert("Error saving card.");
    });
  });
</script>
{% endblock %}